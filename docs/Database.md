# Database

## General notes

- Language: Postgres
- Provider: Supabase
- Naming conventions: snake_case, singular

## Integration

- Website queries `icon` table by:
  - `version` to only include icons associated with the currently deployed version
  - an `ilike` query on `name` to search for icons by name
- For each `icon`, the website queries the `provider` table to get the provider details
- For each `provider`, the website queries the `license` table to get the license details for the provider

## Table Schemas

[Supabase Studio](https://supabase.com/dashboard/project/ojglkplkgnfcbmejsxvb/database/schemas)

![Database Schema](https://i.imgur.com/Nj7azeG.png)

### icon

```sql
CREATE TABLE "public"."icon" (
    "id" bigint GENERATED BY DEFAULT AS IDENTITY NOT NULL, -- Unique identifier for the icon
    "created_at" timestamp with time zone NOT NULL, -- Timestamp when the icon was created
    "build_id" text NOT NULL, -- Version & environment of the icon (e.g., '0.0.1-development')
    "name" text NOT NULL, -- Icon filename without extension
    "svg" text NOT NULL, -- Cleaned SVG markup content
    "source_url" text NOT NULL, -- Direct GitHub URL to the original icon file
    "provider_id" bigint NOT NULL, -- Foreign key reference to provider table
    "jsx" text NOT NULL, -- JSX/React component representation of the icon
    "tags" text[] -- Array of string tags for categorizing and searching icons
);
```

### provider

```sql
CREATE TABLE "public"."provider" (
    "id" bigint GENERATED BY DEFAULT AS IDENTITY NOT NULL, -- Unique identifier for the provider
    "created_at" timestamp with time zone NOT NULL DEFAULT now(), -- Timestamp when the provider was created
    "name" text NOT NULL, -- Human-readable provider name (e.g., 'Hero Icons', 'Lucide')
    "git_url" text NOT NULL -- Repository URL for the icon provider (e.g., 'https://github.com/heroicons/heroicons.git')
    "git_branch" text NOT NULL, -- Git branch for the icon provider (e.g., 'main')
    "git_icons_dir" text NOT NULL, -- Git directory for the icon provider (e.g., 'icons')
);
```

### license

```sql
CREATE TABLE "public"."license" (
    "id" bigint GENERATED BY DEFAULT AS IDENTITY NOT NULL, -- Unique identifier for the license
    "created_at" timestamp with time zone NOT NULL DEFAULT now(), -- Timestamp when the license was created
    "type" text NOT NULL, -- License type (e.g., 'MIT', 'CC BY 4.0', 'Apache 2.0')
    "url" text NOT NULL -- URL to the full license text
    "provider_id" bigint NOT NULL -- Foreign key reference to provider table
);
```

### TODO: license_type

```sql
CREATE TABLE "public"."license_type" (
    "id" varchar NOT NULL, -- Unique identifier for the license type (e.g., 'mit', 'cc_by_4', 'apache_2')
    "name" varchar NOT NULL, -- License name (e.g., 'MIT License', 'Creative Commons Attribution 4.0')
    "type" varchar NOT NULL, -- License category (e.g., 'MIT', 'CC BY', 'Apache', 'ISC', 'CC0')
    "user_obligations" text NOT NULL, -- What users must do when using icons with this license type
    "website_obligations" text NOT NULL -- What the website must do regarding this license type
);
```

## Types

### Auto-Generated Type System

### Overview

This project uses a two-tier type generation system for type safety and validation.

Run `pnpm run db:generate-schemas` to create the following:

1. **TypeScript Types** - Generated from Supabase database schema
2. **Zod Schemas** - Generated from TypeScript types for runtime validation

The underlying logic is stored in `scripts/generate-schemas.sh`

### Create Typescript Types

```bash
supabase gen types typescript --local > src/lib/schemas/database.types.ts
```

Creates `src/lib/schemas/database.types.ts` - TypeScript interfaces for all tables

### Create Zod Schemas

```bash
npx supazod -i src/lib/schemas/database.types.ts -o src/lib/schemas/_database.ts
```

Creates `src/lib/schemas/_database.ts` - Zod validation schemas
We then import the schemas into `src/lib/schemas/database.ts` and re-export them for use in the project in a more convenient way

### Usage

```typescript
import { IconSchema } from '@/lib/schemas/database'

const icon = IconSchema.Row.parse({
  id: 1,
  name: 'icon',
  svg: '<svg>...</svg>',
})
```
